<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <title>Initramfs Tuning</title>
    <meta charset="UTF-8" />
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />

    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />

    <!-- reveal.js CSS theme and local overrides -->
    <link rel="stylesheet" href="reveal.js/dist/reveal.css"/>
    <link rel="stylesheet" href="reveal.js/dist/theme/simple.css"/>
    <link rel="stylesheet" href="reveal.js/plugin/highlight/monokai.css"/>
    <link rel="stylesheet" href="css/reveal-override.css"/>

</head>
<body>
    <div class="reveal">
      <div class="slides">
	<section>
	  <section class="cover" data-state="cover-alternate" id="cover-page-alternate">
	    <div class="date-location">22 October 2021</div>
	    <div class="title">
	      <h1>Tuning Initramfs Generation and Kernel Updates</h1>
	      <h2>Martin Wilck, David Disseldorp, SUSE Labs</h2>
	    </div>
	  </section>
	  <section data-markdown data-state="normal toc" class="toc">
	    # Agenda

	    1. Compression Algorithms: Speed and Efficiency (Martin)
	    > Comparing `xz` and `zstd` compression for initramfs images and
	    kernel modules, respectively

	    2. Tuning Installation of Kernel and KMPs (Martin)
	    > Profiling installation of kernel packages and kernel module
	      packages (KMPs), and assessing the effect of various
	      improvements

	    3. Using cpio-reflinks for Initramfs images (David)
	    > In-depth discussion of the new approach for storing initramfs images
	  </section>
	  <section data-state="normal">
	    <h1>Are you a Leap 15.3 user?</h1>
	    <div class="multicol">
	      <div class="col" style="flex-grow: 1.4">
		<!-- can't use "data-autoplay" here, because every fragment
		activation resets the video. "data-ignore" doesn't help,
		either. -->
		<video controls>
		  <source data-src="images/kernel-update.mp4" />
		</video>
	      </div>
	      <div class="col">
		<ul>
		  <li class="fragment">kernel installation or update is slooow</li>
		  <li class="fragment">Installation of Kernel Module Packages (KMPs)
		  is even slower</li>
		  <li class="fragment">On SLE15-SP3 / Leap 15.3, it seems
		  worse than before</li>
		  <li class="fragment">
		    In this talk, we will examine the reasons and possible remedies
		  </li>
		  <li class="fragment">
		    ... with special attention to initramfs creation
		  </li>
		</ul>
	      </div>
	    </div>
	  </section>
	</section>

	<section>
	  <section data-state="divider" id="divider" class="divider">
	    <h1>Compression Algorithms: Speed and Efficiency</h1>
	    <a href="https://pixahive.com/photo/the-vintage/">
	      <img alt="the vintage" src="images/the-vintage-115544-pixahive-1024x768.jpg"
		   title="By vedhadharani (https://pixahive.com/portfolio/vedasam) [CC0]"
		   href="https://pixahive.com/photo/the-vintage/"/>
	    </a>
	  </section>

	  <section data-markdown data-state="normal">
<script type="text/template">
# Module and Initramfs Compression

|                     | Initramfs             | Modules                      |
|:--------------------|:----------------------|:-----------------------------|
| Affects size of     | Initramfs             | kernel (package & installed) |
| Compress            | **dracut**            | kernel build (OBS)           |
| Uncompress          | early boot            | **modprobe**, **depmod**     |
| xz in SLE since     | SLE12                 | SLE15-SP3                    |
| zstd supported with | v5.9, **dracut** 054  | v5.13, **kmod** 28           |
| zstd in SLE         | SLE15-SP4 (SLE-20248) | SLE15-SP4 (SLE-21256)        |
</script>
	  </section>

	  <section data-state="normal">
	    <h1>Initramfs Compression: Study</h1>

	    <p><strong>20 systems:</strong>
	      <tt>x86_64</tt>, <tt>ppc64le</tt>, <tt>aarch64</tt>, <tt>s390x</tt>,
	      virtual and bare metal, Operating Systems: SLE15-SP2/SP3,
	      Tumbleweed. The size of the <strong>uncompressed</strong>
	      initramfs was 40 MiB (±7MiB) on average.
	    </p>
	    <div class="multicol">
	      <div class="col">
		  <img class="fragment" src="images/compression-mb.svg"/>
	      </div>
	      <div class="col">
		  <img class="fragment" src="images/compression-time.svg"/>
	      </div>
	    </div>
	  </section>

	  <section data-markdown data-state="normal">
	      # Switch the default initramfs compression to zstd!

	      * Consistent test results over a large variety of test systems
	      * **Cost:** ~2MiB disk space
	      * **Gain:** ~3s per initramfs build, 10-20x faster decompression time
	      * This agrees with expectations based on [previous studies](https://engineering.fb.com/2016/08/31/core-data/smaller-and-faster-data-compression-with-zstandard/)
	      * Achieves consistent results with multithreading, scales well
	      * Recommended options `zstd -T0 -3` (the default)
	      * CoW reflinks (Davids topic) may be even better *(stay awake!)*
            </script>
	  </section>

	  <section data-markdown data-state="normal">
<script type="text/template">
# Module Compression: Effect on Disk Usage
## For kernel-default, x86_64

|                 | # modules | rpm size | modules  | initramfs (xz)|
|:----------------|----------:|---------:|---------:|----------:|
| SLE15-SP2       |      2061 |      55M |    170M  | 12M |
| SLE15-SP3 (xz)  |      2165 |      67M |     35M  | 15M |
| SLE15-SP3 (zst) |      2165 |      79M |     47M  | 18M |

* `zstd` saves 123MiB (72%) of disk space used for modules, `xz` 135MiB (79%)
* **Package** and **initramfs** size is smallest for uncompressed modules
* **Total** additional disk space `zstd` vs. `xz`: **~17 MiB**

<p class="footnote">
Note that the rpm <tt>%{size}</tt> property of SUSE kernel
packages is incorrect because of the included <tt>%{ghost}</tt> files.</p>
  

<!--  | TW 2109 (xz)    |      4706 |     107M |     78M  | 41M (17M) | -->
</script>

	  </section>
	  <section data-state="normal">
	    <h1>Module Compression: Effect on Speed</h1>
	      <div class="multicol">
		<div class="col"  data-markdown>
### Booting

A kernel typically loads between 2MiB and 20MiB of modules during boot.
This is loaded in fragments of a second on any decent computer.
		</div>
		<div class="col" data-markdown>
### Building

Time required for module compression in OBS is decreased from ~30s to
~5s. This is negligble compared to the time spent during the actual
build, signing, and the antivirus check.
		</div>
		<div class="col" data-markdown>
### Other

The runtime of `depmod` is strongly affected by module compression.
Does this matter? We will see ...
		</div>
	      </div>
	    </section>
	</section>


	<section>
  <!--
	  <section data-state="divider" id="divider">
	    <h1>Initramfs Building and Installation of Kernel and KMPs</h1>
	    <a href="https://pixabay.com/photos/building-to-build-framework-1210677/">
	      <img alt="Building to Build Framework" src="images/building-1210677_1280.jpg"
		   title="Image by Hands off my tags! Michael Gaida from Pixabay [Pixabay License]"
		   href="https://pixabay.com/photos/building-to-build-framework-1210677/"/>
	    </a>
	  </section>
-->
	  <section data-state="divider" class="divider" id="divider">
	    <h1>Tuning Installation of kernel and KMPs</h1>
	    <a href="https://pixabay.com/de/photos/vw-vw-k%c3%a4fer-volkswagen-k%c3%a4fer-4024868/">
	      <img alt="Building to Build Framework" src="images/vw-4024868_1280.jpg"
		   title="Bild von Reinhard Thrainer auf Pixabay [Pixabay License]"
		   href="https://pixabay.com/de/photos/vw-vw-k%c3%a4fer-volkswagen-k%c3%a4fer-4024868/"/>
	    </a>
	  </section>
	  <section data-state="normal">
	    <h1>Some Background about weak-modules2</h1>
	    <p><tt>weak-modules2</tt> is always involved if a package
	      with kernel modules is installed or removed.</p>
	      <div class="multicol">
		<div class="col"  data-markdown>
### Kernel installation / update

1. Call `depmod`
2. If KMPs are installed, for each KMP:
   - check KABI compatibility and create `weak-modules`
     symlinks as appropriate. This requires calling `depmod`.
3. Call `dracut` to rebuild the initramfs.

Similar for "pseudo-KMPs" and kernel subpackages (`-extra`, `-optional`)
		</div>
		<div class="col" data-markdown>
### KMP installation

For all installed kernels:
1. Check if the KMP being installed replaces an existing one
2. Attempt replacement or addition, check KABI compatibility (requires
`depmod`)
3. Add `weak-modules` symlinks as appropriate
4. Run `depmod`
5. If modules in Initramfs are affected (`lsinitrd`), schedule Initramfs rebuild
		</div>
	      </div>
	    </section>
	  <section data-state="normal">
	    <h1>Opportunities for Optimization</h1>
	    <ul>
	      <li class="fragment" data-fragment-index="1">
		Replace dracut's slow <tt>lsinitrd</tt> program with a
		simpler, faster one;
	      </li>
	      <li class="fragment" data-fragment-index="2">
		Use <strong>zstd compression</strong> for the initramfs;
	      </li>
	      <li class="fragment" data-fragment-index="3">
		Use <strong>cpio reflinking</strong> for the initramfs;
	      </li>
	      <li class="fragment" data-fragment-index="4">
		Postpone building the initramfs from <tt>%post</tt>
		to <tt>%posttrans</tt> to avoid building it multiple times.
		This is simplified by the recent endeavor to outsource
		the <strong>rpm scriptlets</strong> of kernel packages
		into separate scripts;
	      </li>
	      <li class="fragment" data-fragment-index="5">
		Avoid running a <tt>depmod</tt> for all modules when just KABI
		compatibility of a few to-be-added module files needs to be
		tested. Developed a patch set for <strong>kmod</strong> to
		achieve this;
	      </li>
	      <li class="fragment" data-fragment-index="6">
		Apply <strong>parallelization</strong> to certain steps:
		<ul>
		  <li>dracut invocation in <tt>%posttrans</tt>,</li>
		  <li>KABI check for multiple kernels;</li>
		</ul>
	      </li>
	      <li class="fragment" data-fragment-index="7">
		Optimize dracut… (not today!).
	      </li>
	    </ul>
	  </section>
	  <section data-state="normal" data-markdown>
<script type="text/template">
# Test Procedure for Optimizations

* Virtual machines set up on decent storage (LV on PCIe NVMe,
  `cache=none`)
* Use **btrfs** snapshots and rollbacks to ensure consistent startup
conditions
* **Profiling:**
  - pipe command output into `logger`
  - Use `journalctl` to retrieve the output messages with
    precise time stamps, parse output with a python script
* **Test step sequence:**
    - install update kernel (base, -extra and -optional if available);
    - install two KMPs, one required for initramfs;
    - install a user space package requiring initramfs rebuild;
    - install anothe update kernel.
* **Validation:** Variability of measurement results < 1% for one setup
</script>
	  </section>
	</section>

	<section>
	  <section data-state="normal">
	    <h1>Kernel Installation with KMPs</h1>
	    <div class="multicol">
	      <div class="col">
		<ol>
		  <li class="fragment" data-fragment-index="1">
		    SLED > SLES, Leap > SLED;
		    Performance deteriorates with SP3 because of <strong>xz</strong>
		  </li>
		  <li class="fragment" data-fragment-index="2">
		    Accelerated lsinitrd
		  </li>
		  <li class="fragment" data-fragment-index="3">
		    cpio reflinking + 2.
		  </li>
		  <li class="fragment" data-fragment-index="4">
		    zstd-compressed modules + 3.
		  </li>
		  <li class="fragment" data-fragment-index="5">
		    zstd for initramfs & modules + 2.
		  </li>
		  <li class="fragment" data-fragment-index="6">
		    new kernel scriptlets + 4.
		  </li>
		  <li class="fragment" data-fragment-index="7">
		    Initramfs in <tt>%possttrans</tt> + 5.
		  </li>
		  <li class="fragment" data-fragment-index="8">
		    Incremental depmod + 6.
		  </li>
		  <li class="fragment" data-fragment-index="9">
		    Parallelization + 7.
		  </li>
		</ul>
	      </div>
	      <div class="col" style="flex-grow: 1.6;">
		<div class="r-stack">
		  <img class="fragment" data-fragment-index="1" src="images/kernel-inst-00.svg"/>
		  <img class="fragment" data-fragment-index="2" src="images/kernel-inst-01.svg"/>
		  <img class="fragment" data-fragment-index="3" src="images/kernel-inst-02.svg"/>
		  <img class="fragment" data-fragment-index="4" src="images/kernel-inst-03.svg"/>
		  <img class="fragment" data-fragment-index="5" src="images/kernel-inst-04.svg"/>
		  <img class="fragment" data-fragment-index="6" src="images/kernel-inst-05.svg"/>
		  <img class="fragment" data-fragment-index="7" src="images/kernel-inst-06.svg"/>
		  <img class="fragment" data-fragment-index="8" src="images/kernel-inst-07.svg"/>
		  <img class="fragment" data-fragment-index="9" src="images/kernel-inst-08.svg"/>
		</div>
	      </div>
	    </div>
	  </section>
	</section>

	<section>
	  <section data-state="normal">
	    <h1>KMP Installation</h1>
	    <div class="multicol">
	      <div class="col">
		<ol>
		  <li class="fragment" data-fragment-index="1">
		    SLED > SLES, Leap > SLED; 
		    Performance deteriorates with SP3
		  </li>
		  <li class="fragment" data-fragment-index="2">
		    Accelerated lsinitrd
		  </li>
		  <li class="fragment" data-fragment-index="3">
		    cpio reflinking + 2.
		  </li>
		  <li class="fragment" data-fragment-index="4">
		    zstd-compressed modules + 3.
		  </li>
		  <li class="fragment" data-fragment-index="5">
		    zstd for initramfs & modules + 2.
		  </li>
		  <li class="fragment" data-fragment-index="6">
		    new kernel scriptlets + 4.
		  </li>
		  <li class="fragment" data-fragment-index="7">
		    Initramfs in <tt>%possttrans</tt> + 5.
		  </li>
		  <li class="fragment" data-fragment-index="8">
		    Incremental depmod + 6.
		  </li>
		  <li class="fragment" data-fragment-index="9">
		    Parallelization + 7.
		  </li>
		</ul>
	      </div>
	      <div class="col" style="flex-grow: 1.6;">
		<div class="r-stack">
		  <img class="fragment" data-fragment-index="1" src="images/KMP-inst-00.svg"/>
		  <img class="fragment" data-fragment-index="2" src="images/KMP-inst-01.svg"/>
		  <img class="fragment" data-fragment-index="3" src="images/KMP-inst-02.svg"/>
		  <img class="fragment" data-fragment-index="4" src="images/KMP-inst-03.svg"/>
		  <img class="fragment" data-fragment-index="5" src="images/KMP-inst-04.svg"/>
		  <img class="fragment" data-fragment-index="6" src="images/KMP-inst-05.svg"/>
		  <img class="fragment" data-fragment-index="7" src="images/KMP-inst-06.svg"/>
		  <img class="fragment" data-fragment-index="8" src="images/KMP-inst-07.svg"/>
		  <img class="fragment" data-fragment-index="9" src="images/KMP-inst-08.svg"/>
		</div>
	      </div>
	    </div>
	  </section>
	</section>

	<section>
	  <section data-state="normal">
	    <h1>Speeding up Installation: Summary</h1>
	    <div class="multicol">
	      <div class="col fragment" data-markdown>
### Kernel update

<!-- * Leap 15.3 > SLED 15 SP3 > SLES 15 SP3 caused by initramfs generation in --
  -- `%post` -->
* Deterioration SP2 ⇒ SP3 caused by **depmod**
* Using either **zstd or cpio-reflinking for Initramfs** saves ~10s, `zstd` is slightly slower
* **zstd compression for modules** saves ~16s
* Initramfs build in `%posttrans` saves ~14s
* **Overall**, with parallelization: **66s ⇒ 21s**
	      </div>
	      <div class="col fragment" data-markdown>
### KMP installation

* Deterioration SP2 ⇒ SP3 caused by **depmod**
* **Accellerated lsinitrd** saves ~10s
* **zstd compression for modules** saves ~40s
* **Incremental depmod** saves ~17s
* **Overall**, with parallelization: **100s ⇒ 15s**
	      </div>
	    </div>
	  </section>

	</section>

        <section data-markdown="markdown/80-reflinks.md"
                 data-separator="^\n\n\n"
                 data-separator-vertical="^\n\n"
                 data-separator-notes="^Note:">
        </section>

        <section data-markdown="markdown/90-postscript.md"
                 data-separator="^\n\n\n"
                 data-separator-vertical="^\n\n"
                 data-separator-notes="^Note:">
        </section>
      </div>
    </div>

    <script src="reveal.js/dist/reveal.js"></script>
    <script src="reveal.js/plugin/markdown/markdown.js"></script>
    <script src="reveal.js/plugin/highlight/highlight.js"></script>
    <script src="reveal.js/plugin/notes/notes.js"></script>
    <script src="reveal.js/plugin/math/math.js"></script>
    <script src="reveal.js/plugin/zoom/zoom.js"></script>
    <script src="reveal.js-menu/menu.js"></script> 
    <script src="js/reveal.js"></script>

    <script src="qrcodejs/qrcode.js"></script>
    <script src="js/qrcode.js"></script>
</body>
</html>
